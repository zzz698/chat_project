<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>èŠå¤©å®¤</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        /* æŒ‰é’®æ ·å¼ */
        #showImageBtn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #008CBA;
            color: white;
            border: none;
            cursor: pointer;
            margin: 30px;
            font-size: 22px;
            border-radius: 4px;
        }
        #showImageBtn:hover {
            background-color: #005f75;
        }

        /* å¼¹çª—é®ç½©å±‚ */
        #imageModal {
            display: none;  /* é»˜è®¤éšè— */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        /* å¼¹çª—å›¾ç‰‡ */
        #imageModal img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 0 15px #000;
        }

        /* å…³é—­æŒ‰é’® */
        #imageModal span.close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }



    </style>
</head>
<body>

<button id="showImageBtn">ç©æ³•ä»‹ç»</button>

<div id="imageModal">
    <span class="close">&times;</span>
    <img src="{% if global_background_url %}{{ global_background_url }}{% else %}/static/default_bg.jpg{% endif %}" alt="å¼¹å‡ºå›¾ç‰‡" />
</div>

<script>
    const btn = document.getElementById('showImageBtn');
    const modal = document.getElementById('imageModal');
    const closeBtn = modal.querySelector('.close');

    btn.onclick = function() {
        modal.style.display = 'flex';
    }
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    // ç‚¹å‡»é®ç½©åŒºåŸŸå…³é—­å¼¹çª—
    modal.onclick = function(e) {
        if(e.target === modal) {
            modal.style.display = 'none';
        }
    }
</script>

</body>

<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
        font-size: 22px;
        overflow: hidden;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #eee;
        padding: 10px 20px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .top-bar h2 {
        font-size: 22px;
        margin: 0;
    }

    .top-bar span,
    .top-bar a {
        font-size: 22px;
        white-space: nowrap;
    }

    #chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: #f2f2f2;
        display: flex;
        flex-direction: column;
    }
    .top-bar,
    #chat-box,
    #message-form {
        background-color: rgba(255, 255, 255,1.00);  /* ç™½è‰² + 80% ä¸é€æ˜ */
        backdrop-filter: blur(5px);  /* å¯é€‰ï¼ŒåŠ ç‚¹ç£¨ç ‚æ„Ÿ */
    }

    .message {
        max-width: 80%;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        word-wrap: break-word;
        font-size: 22px;
    }

    .left {
        align-self: flex-start;
        background-color: #e4e4e4;
    }

    .right {
        align-self: flex-end;
        background-color: #cce5ff;
    }

    .message img {
        max-width: 100%;
        height: auto;
        margin-top: 5px;
        border-radius: 5px;
    }

    #message-form {
        display: flex;
        flex-direction: column;
        padding: 10px 15px;
        background-color: #fff;
    }

    #msg-input {
        padding: 10px;
        font-size: 22px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: vertical;
        margin-bottom: 10px;
    }

    #message-form input[type="file"] {
        font-size: 22px;
        margin-bottom: 10px;
    }

    #message-form button {
        align-self: flex-end;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 22px;
    }

    #message-form button:hover {
        background-color: #0056b3;
    }

    #chat-log {
        text-align: center;
    }

    .countdown-message {
        font-size: 1.5em;
        margin: 10px auto;
        padding: 10px;
        background-color: #ffecec;
        border: 1px solid red;
        display: inline-block;
        border-radius: 8px;
    }

    @media screen and (max-width: 768px) {
        body, .top-bar, .top-bar h2, .top-bar span, .top-bar a,
        #showImageBtn, .message, #msg-input,
        #message-form input[type="file"], #message-form button,
        .countdown-message {
            font-size: 100% !important;
        }

        /* å¯é€‰ï¼šå¦‚æœä½ è¿˜æœ‰å…¶ä»–å…ƒç´ éœ€è¦å˜å¤§å­—ä½“ï¼Œä¸€å¹¶åŠ ä¸Š */
    }



</style>
</head>
<body>
<div class="top-bar">
    <h2>æ¢¦å¹»ç‚¼å¦–ä¸»å‰¯ç‰›ç‰›ç¾¤</h2>
    <span>å½“å‰ç”¨æˆ·ï¼š<strong>{{ request.user.username }}</strong></span>
    <span id="ws-status" style="float:right; color:green;">ğŸŸ¢ åœ¨çº¿</span>
    {% if user.is_authenticated %}
        <a href="{% url 'logout' %}">é€€å‡ºç™»å½•</a>

    {% else %}
        <p>æ¸¸å®¢åªè¯» <a href="{% url 'login' %}">ç™»å½•</a></p>
    {% endif %}
</div>

<div id="chat-box">
    {% for msg in messages %}
        {#        <div class="message {% if msg.user == user %}right{% else %}left{% endif %}">#}
        <div class="message {% if msg.user == user %}right{% else %}left{% endif %}" data-id="{{ msg.id }}">


            {% load static %}
            {% load tz %}
            {% get_media_prefix as MEDIA_URL %}



            {#            <img src="{{ MEDIA_URL }}avatars/{{ msg.user.username }}.jpg"#}
            <img src="/media/avatars/avatars/{{ msg.user.username }}.jpg"
                 alt="å¤´åƒ"
                 style="width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 5px;"
                 onerror="this.onerror=null;this.src='/media/avatars/zzzz.jpg';">
            <strong {% if msg.user.username == 'è¶…çº§ç®¡ç†' %}style="color: red;"{% endif %}>{{ msg.user.username }}</strong>ï¼š{{ msg.text|linebreaksbr }}



            {% if msg.image %}
                <img src="{{ msg.image.url }}" alt="å›¾ç‰‡">
            {% endif %}
            <div>
                <small>{{ msg.timestamp|timezone:"Asia/Shanghai"|date:"Y-m-d H:i:s" }}</small>
            </div>


        </div>
    {% endfor %}
</div>

<div id="chat-log"></div>
{% if request.user.username == 'è¶…çº§ç®¡ç†' %}
    <div class="root-buttons" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <button onclick="handleStart()">å¼€å§‹ä¸‹å•</button>
            <button onclick="sendPresetMessage('åœæ­¢ä¸‹å•')">åœæ­¢ä¸‹å•</button>
            <button onclick="sendPresetMessage('å€’è®¡æ—¶å›¾')">å€’è®¡æ—¶</button>
        </div>
        <script>

            function handleStart() {
                sendPresetMessage('å¼€å§‹ä¸‹å•');              // å‘é€â€œå¼€å§‹ä¸‹å•â€
                sendPresetMessage('å€’è®¡æ—¶å›¾');


                setTimeout(() => {
                    sendPresetMessage('åœæ­¢ä¸‹å•');
                }, 100000); // 100000ms = 100 ç§’
            }
        </script>
        <div>
            <a href="/register/" style="margin-right: 12px; padding: 6px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none;">æ³¨å†Œæ–°ç”¨æˆ·</a>
            <a href="/upload_global_background" style="padding: 6px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none;">è®¾ç½®ä¸»é¡µè¯´æ˜</a>
        </div>
    </div>
{% endif %}

{% if user.is_authenticated %}
    <form id="message-form" method="post" enctype="multipart/form-data" action="{% url 'post_message' %}">
        {% csrf_token %}
        <textarea id="msg-input" name="text" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ç²˜è´´å›¾ç‰‡..." rows="3"></textarea>
        <input type="file" id="image-input" name="image" accept="image/*">
        <button type="submit">å‘é€</button>

    </form>
{% endif %}



<script>
    const chatBox = document.getElementById('chat-box');
    const socket = new WebSocket('ws://' + window.location.host + '/ws/chat/');
    const form = document.getElementById('message-form');
    const msgInput = document.getElementById('msg-input');
    let pastedImageFile = null;

    const wsStatus = document.getElementById('ws-status');

    socket.onopen = () => {
        wsStatus.textContent = 'ğŸŸ¢ åœ¨çº¿';
        wsStatus.style.color = 'green';
    };

    socket.onclose = () => {
        wsStatus.textContent = 'ğŸ”´ ç¦»çº¿';
        wsStatus.style.color = 'red';
    };

    socket.onerror = () => {
        wsStatus.textContent = 'âš ï¸ å¼‚å¸¸';
        wsStatus.style.color = 'orange';
    };




    // æ»šåŠ¨åˆ°åº•éƒ¨
    window.onload = () => {
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    {% if user.is_authenticated %}
        // ç²˜è´´å›¾ç‰‡äº‹ä»¶ç›‘å¬
        msgInput.addEventListener('paste', function(event) {
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    pastedImageFile = file;

                    const imgURL = URL.createObjectURL(file);
                    const preview = document.createElement('div');
                    preview.classList.add('message', 'right');
                    preview.id = 'preview-message';
                    preview.innerHTML = `
                            <div style="position: relative;">
                                <button id="cancel-preview" style="
                                    position: absolute; top: 0; right: 0;
                                    background: transparent; border: none; color: red;
                                    font-size: 26px; cursor: pointer;">Ã—</button>
                                <strong>æˆ‘</strong>ï¼š<br>
                                <img src="${imgURL}" alt="é¢„è§ˆå›¾"><br>
                                        <small>é¢„è§ˆä¸­...</small>
                            </div>
                        `;

                    setTimeout(() => {
                        const cancelBtn = document.getElementById('cancel-preview');
                        if (cancelBtn) {
                            cancelBtn.addEventListener('click', () => {
                                const previewMsg = document.getElementById('preview-message');
                                if (previewMsg) previewMsg.remove();
                                pastedImageFile = null;
                            });
                        }
                    }, 0);

                    const old = document.getElementById('preview-message');
                    if (old) old.remove();

                    chatBox.appendChild(preview);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });

    {% endif %}


    function startCountdownDisplay(seconds, user) {
        const msgBox = document.getElementById("chat-log");

        const container = document.createElement("div");
        container.className = "countdown-message";
        container.style.color = "red";
        container.style.textAlign = "center"; // å±…ä¸­æ˜¾ç¤º
        container.innerHTML = `<b>ä¸‹å•å€’è®¡æ—¶ï¼š</b> <span id="countdown">${seconds}</span> ç§’`;

        msgBox.appendChild(container);
        msgBox.scrollTop = msgBox.scrollHeight;

        let remaining = seconds;
        const countdownSpan = container.querySelector("#countdown");

        const interval = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(interval);
                countdownSpan.textContent = "ç»“æŸ";

                // â³ 5ç§’ååˆ é™¤è¿™ä¸ªå…ƒç´ 
                setTimeout(() => {
                    container.remove();
                }, 5000);
            } else {
                countdownSpan.textContent = remaining;
            }
        }, 1000);
    }

    function compressImage(file, maxSizeKB, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            const img = new Image();
            img.src = e.target.result;

            img.onload = function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = Math.sqrt(maxSizeKB * 1024 / file.size);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(function (blob) {
                    const compressedFile = new File([blob], file.name, { type: file.type });
                    callback(compressedFile);
                }, file.type, 0.9);
            };
        };
    }


    const currentUser = "{{ user.username|escapejs|default:'' }}";

    socket.onmessage = function(e) {
        let data;
        try {
            data = JSON.parse(e.data);
        } catch (err) {
            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', err, e.data);
            return;
        }
        console.log('æ”¶åˆ°æ¶ˆæ¯:', data);

        if (data.message==="å€’è®¡æ—¶100") {
            const duration = parseInt(data.message.replace("å€’è®¡æ—¶", "").trim());
            if (!isNaN(duration)) {
                startCountdownDisplay(duration, data.user);
                return;
            }
        }

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');


        if (data.type === 'chat.recall') {
            const msgId = String(data.id);
            const msgElem = document.querySelector(`.chat-msg[data-id="${msgId}"]`);
            if (msgElem) {
                msgElem.innerHTML = `<em style="color: gray;">å·²è¢«æ’¤å›</em>`;
            }
            return;
        }




        if (currentUser && data.user === currentUser) {
            msgDiv.classList.add('right');
            const preview = document.getElementById('preview-message');
            if (preview) preview.remove();
        } else {
            msgDiv.classList.add('left');
        }

        // æ¶ˆæ¯æ—¶é—´æˆ³ï¼ŒæœåŠ¡å™¨ä¼ æ¥çš„ ISO æ ¼å¼å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸º Date å¯¹è±¡
        {#        let msgTime = new Date(data.timestamp);#}
        {#        let now = new Date();#}
        {#// è½¬æˆ UTC æ—¶é—´æ¯«ç§’æ•°#}
        {#        let msgTimeUTC = msgTime.getTime();#}
        {#        let nowUTC = now.getTime();#}
        {##}
        {#// è®¡ç®—æ—¶é—´å·®ï¼Œå•ä½æ¯«ç§’#}
        {#        let diff = nowUTC - msgTimeUTC;#}

        let diff = Date.now() - Date.parse(data.timestamp);


        // å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œä¸”æ—¶é—´å·® <= 30ç§’ï¼Œæ˜¾ç¤ºæ’¤å›æŒ‰é’®
        let recallBtnHtml = '';
        console.log('diff:', diff, 'currentUser:', currentUser, 'data.user:', data.user);

        if (currentUser && data.user === currentUser && diff <= 28800673 +30000 || currentUser==="è¶…çº§ç®¡ç†" ) {
            recallBtnHtml = `<button class="recall-btn" data-msgid="${data.id}" style="margin-left: 10px; cursor: pointer;">æ’¤å›</button>`;
        }

        let avatarUrl = `/media/avatars/avatars/${data.user}.jpg`;
        let defaultAvatar = '/media/avatars/xxx.jpg';
        let img = new Image();
        img.src = avatarUrl;

        // å°è¯•åŠ è½½ï¼Œå¦‚æœå¤±è´¥å°±æ›¿æ¢ä¸ºé»˜è®¤å¤´åƒ
        img.onerror = function () {
            avatarUrl =defaultAvatar
        };
        let usernameHtml = `
        <img src="${avatarUrl}" alt="å¤´åƒ" onerror="this.onerror=null;this.src='${defaultAvatar}';" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:5px;">
        <strong ${data.user === 'è¶…çº§ç®¡ç†' ? 'style="color:red;"' : ''}>${data.user || 'æ¸¸å®¢'}</strong>
    `;

        let html = `
        <div id="msg-${data.id}" class="chat-msg" data-id="${data.id}">
            ${usernameHtml}ï¼š${(data.message || '').replace(/\n/g, '<br>')}
        </div>
        `;

        if (data.image) {
            html += `<br><img src="${data.image}" alt="å›¾ç‰‡">`;
        }

        // ğŸ‘‡ æŠŠæ—¶é—´å’Œæ’¤å›æŒ‰é’®æ‹¼åœ¨ä¸€èµ·
        html += `<br><small>${data.timestamp || ''}</small>${recallBtnHtml}`;

       // åˆ¤æ–­æ˜¯å¦åœ¨åº•éƒ¨
        isAtBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 1000;

        // æ’å…¥æ–°æ¶ˆæ¯
        msgDiv.innerHTML = html;
        chatBox.appendChild(msgDiv);

        // å¦‚æœåŸæœ¬åœ¨åº•éƒ¨ï¼Œåˆ™è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (isAtBottom) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

// ğŸ‘‡ å¦‚æœç”Ÿæˆäº†æ’¤å›æŒ‰é’®ï¼Œåˆ™è®¾ç½®30ç§’åè‡ªåŠ¨ç§»é™¤
        if (recallBtnHtml &&  currentUser!=="è¶…çº§ç®¡ç†"  ) {
            setTimeout(() => {
                const recallBtn = document.querySelector(`.recall-btn[data-msgid="${data.id}"]`);
                if (recallBtn) recallBtn.remove();
            }, 30000); // 30ç§’åè‡ªåŠ¨åˆ é™¤æŒ‰é’®
        }
        // åˆ¤æ–­æ˜¯å¦åœ¨åº•éƒ¨
        isAtBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 1000;

        // æ’å…¥æ–°æ¶ˆæ¯
        msgDiv.innerHTML = html;
        chatBox.appendChild(msgDiv);

        // å¦‚æœåŸæœ¬åœ¨åº•éƒ¨ï¼Œåˆ™è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (isAtBottom) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        {#msgDiv.innerHTML = html;#}
        {#chatBox.appendChild(msgDiv);#}
        {#chatBox.scrollTop = chatBox.scrollHeight;#}

        // æ’¤å›æŒ‰é’®äº‹ä»¶ç»‘å®š
        if (diff <= 28800673 +30000 && data.user === currentUser || currentUser==="è¶…çº§ç®¡ç†" ) {
            const recallBtn = msgDiv.querySelector('.recall-btn');
            recallBtn.onclick = function() {
                const msgId = this.getAttribute('data-msgid');
                if (confirm('ç¡®è®¤æ’¤å›è¿™æ¡æ¶ˆæ¯ï¼Ÿ')) {
                    // å‘é€æ’¤å›è¯·æ±‚
                    fetch(`/recall_message/${msgId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                    }).then(res => {
                        if (res.ok) {
                            alert('æ¶ˆæ¯å·²æ’¤å›');
                        } else {
                            alert('æ’¤å›å¤±è´¥ï¼Œå¯èƒ½è¶…è¿‡æ—¶é—´é™åˆ¶');
                        }
                    }).catch(err => {
                        alert('ç½‘ç»œé”™è¯¯ï¼Œæ’¤å›å¤±è´¥');
                    });
                }
            };
        }
    };


    // è¡¨å•æäº¤æ‹¦æˆª
    let lastSentTime = 0; // è®°å½•ä¸Šä¸€æ¬¡å‘é€æ—¶é—´æˆ³

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const text = msgInput.value.trim();
        const fileInput = form.querySelector('input[type="file"]');
        const selectedFile = fileInput.files[0];

        let imageFile = pastedImageFile || selectedFile;

        // æ˜¯å¦ç©ºæ¶ˆæ¯
        if (!text && !imageFile) {
            alert('ä¸èƒ½å‘é€ç©ºæ¶ˆæ¯ï¼');
            return;
        }

        // æ£€æŸ¥æ—¶é—´é—´éš”
        const now = Date.now();
        if (now - lastSentTime < 2000) {
            alert('è¯·ä¸è¦é¢‘ç¹å‘é€æ¶ˆæ¯ï¼ˆé—´éš”éœ€å¤§äº 2 ç§’ï¼‰');
            return;
        }

        function doUpload(finalImageFile) {
            const formData = new FormData(form);
            if (finalImageFile) {
                formData.set('image', finalImageFile); // è¿™æ—¶å€™æ‰åŠ å›¾ç‰‡
            }

            lastSentTime = Date.now();

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(response => {
                if (response.ok) {
                    msgInput.value = '';
                    fileInput.value = '';
                    pastedImageFile = null;
                    const preview = document.getElementById('preview-message');
                    if (preview) preview.remove();
                }
            });
        }

        // å›¾ç‰‡å¤§äº200KBåˆ™å‹ç¼©åä¸Šä¼ 
        if (imageFile && imageFile.size > 204800) {
            compressImage(imageFile, 200, function (compressed) {
                alert('å‹ç¼©åå¤§å°ï¼š' + (compressed.size / 1024).toFixed(2) + 'KB');
                doUpload(compressed);
            });
        } else {
            doUpload(imageFile);
        }
    });



    // ç»‘å®š Enter è‡ªåŠ¨æäº¤
    msgInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // é˜»æ­¢æ¢è¡Œ
            form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
    });

    //å‰ç«¯ä»£ç ä¿®æ”¹ï¼ˆæŒ‰é’®ç‚¹å‡»å‘é€ AJAX è¯·æ±‚ï¼‰
    function sendPresetMessage(text) {
        fetch("{% url 'send_preset' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ command: text })
        }).then(response => {
            if (!response.ok) {
                alert("å‘é€å¤±è´¥");
            }
        });
    }



</script>
</body>


</html>
